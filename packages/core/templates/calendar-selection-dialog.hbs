<div class="dialog-content">
  <div class="calendar-selection-layout">
    <!-- Left Panel: Calendar List (Master) -->
    <div class="calendar-list-panel">
      <div class="panel-header">
        <h3>{{localize "SEASONS_STARS.dialog.calendar_selection.available_calendars"}}</h3>
      </div>

      <div class="calendar-list-container">
        {{#if calendarsByModule}}
          {{#each calendarsByModule}}
          <div class="module-group {{#if collapsed}}collapsed{{/if}}" data-module-id="{{moduleId}}">
            <div class="module-header" data-action="toggleModule" data-module-id="{{moduleId}}">
              <i class="fas fa-chevron-down collapse-icon"></i>
              <i class="{{moduleIcon}} module-icon"></i>
              <span class="module-name">{{moduleName}}</span>
              <span class="calendar-count">{{calendarCount}}</span>
            </div>

            <div class="module-calendars">
              {{#each calendars}}
              <div class="calendar-list-item {{#if isCurrent}}current{{/if}} {{#if isSelected}}selected{{/if}}"
                   data-action="selectCalendar"
                   data-calendar-id="{{id}}">
                <div class="calendar-list-main">
                  <div class="calendar-list-title">
                    {{#if isCurrent}}
                    <i class="fas fa-star current-icon"></i>
                    {{/if}}
                    {{label}}
                  </div>
                  {{#if tags}}
                  <div class="calendar-list-tags">
                    {{#each tags}}
                    <span class="tag">{{this}}</span>
                    {{/each}}
                  </div>
                  {{/if}}
                </div>
              </div>
              {{/each}}
            </div>
          </div>
          {{/each}}
        {{/if}}

        {{#if showFilePicker}}
        <div class="module-group file-picker-group">
          <div class="module-header">
            <i class="fas fa-folder-open module-icon"></i>
            <span class="module-name">{{localize "SEASONS_STARS.dialog.calendar_selection.custom_file"}}</span>
          </div>

          <div class="module-calendars">
            <div class="calendar-list-item {{#if filePickerActive}}current{{/if}} {{#if filePickerSelected}}selected{{/if}}"
                 {{#if selectedFilePath}}data-action="selectCalendar" data-calendar-id="__FILE_PICKER__"{{else}}data-action="openFilePicker"{{/if}}>
              <div class="calendar-list-main">
                <div class="calendar-list-title">
                  {{#if filePickerActive}}
                  <i class="fas fa-star current-icon"></i>
                  {{/if}}
                  {{#if selectedFilePath}}
                  {{selectedFileName}}
                  {{else}}
                  {{localize "SEASONS_STARS.dialog.calendar_selection.browse_for_file"}}
                  {{/if}}
                </div>
                {{#if selectedFilePath}}
                <div class="calendar-list-tags">
                  <span class="tag">custom</span>
                </div>
                {{/if}}
              </div>
            </div>
          </div>
        </div>
        {{/if}}
      </div>
    </div>

    <!-- Right Panel: Calendar Details -->
    <div class="calendar-detail-panel">
      {{#if selectedCalendarData}}
      <div class="detail-content">
        <div class="detail-header">
          <h2 class="detail-title">{{selectedCalendarData.label}}</h2>
          {{#if selectedCalendarData.setting}}
          <p class="detail-setting">{{selectedCalendarData.setting}}</p>
          {{/if}}
        </div>

        {{#if selectedCalendarData.description}}
        <div class="detail-section">
          <h4>{{localize "SEASONS_STARS.dialog.calendar_selection.description"}}</h4>
          <p>{{selectedCalendarData.description}}</p>
        </div>
        {{/if}}

        <div class="detail-section">
          <h4>{{localize "SEASONS_STARS.dialog.calendar_selection.date_formats"}}</h4>
          <div class="format-preview">
            <div class="format-item">
              <label>{{localize "SEASONS_STARS.dialog.calendar_selection.full_widget"}}:</label>
              <span class="format-sample">{{selectedCalendarData.sampleDate}}</span>
            </div>
            <div class="format-item">
              <label>{{localize "SEASONS_STARS.dialog.calendar_selection.mini_widget"}}:</label>
              <span class="format-sample mini">{{selectedCalendarData.miniPreview}}</span>
            </div>
          </div>
        </div>

        <div class="detail-section">
          <h4>{{localize "SEASONS_STARS.dialog.calendar_selection.source_info"}}</h4>
          <div class="source-details">
            <div class="source-item">
              <i class="{{selectedCalendarData.sourceIcon}} source-icon"></i>
              <span>{{selectedCalendarData.sourceLabel}}</span>
            </div>
          </div>
        </div>

        {{#if selectedCalendarData.calendarSources}}
        <div class="detail-section">
          <h4>{{localize "SEASONS_STARS.dialog.calendar_selection.references"}}</h4>
          <div class="references-list">
            {{#each selectedCalendarData.calendarSources}}
            {{#if isUrl}}
            <div class="reference-item">
              <i class="fas fa-link"></i>
              <a href="{{url}}" target="_blank" rel="noopener noreferrer">{{url}}</a>
            </div>
            {{else}}
            <div class="reference-item citation">
              <i class="fas fa-book"></i>
              <span class="citation-text">{{citation}}</span>
              {{#if notes}}
              <span class="citation-notes">{{notes}}</span>
              {{/if}}
            </div>
            {{/if}}
            {{/each}}
          </div>
        </div>
        {{/if}}

        {{#if selectedCalendarData.author}}
        <div class="detail-section">
          <h4>{{localize "SEASONS_STARS.dialog.calendar_selection.author"}}</h4>
          <p>{{selectedCalendarData.author}}</p>
        </div>
        {{/if}}

        {{#if selectedCalendarData.tags}}
        <div class="detail-section">
          <h4>{{localize "SEASONS_STARS.dialog.calendar_selection.tags"}}</h4>
          <div class="tags-display">
            {{#each selectedCalendarData.tags}}
            <span class="tag">{{this}}</span>
            {{/each}}
          </div>
        </div>
        {{/if}}
      </div>
      {{else if filePickerSelected}}
      <div class="detail-content file-picker-detail">
        <div class="detail-header">
          <h2 class="detail-title">{{localize "SEASONS_STARS.dialog.calendar_selection.custom_file"}}</h2>
        </div>

        <div class="detail-section">
          {{#if selectedFilePath}}
          <h4>{{localize "SEASONS_STARS.dialog.calendar_selection.file_path"}}</h4>
          <p class="file-path-display">{{selectedFilePath}}</p>

          <div class="file-actions">
            <button type="button" data-action="clearFilePicker" class="button">
              <i class="fas fa-times"></i>
              {{localize "SEASONS_STARS.dialog.calendar_selection.clear_file"}}
            </button>
          </div>
          {{else}}
          <p class="no-file-message">{{localize "SEASONS_STARS.dialog.calendar_selection.no_file_selected"}}</p>

          <div class="file-actions">
            <button type="button" data-action="openFilePicker" class="button">
              <i class="fas fa-folder-open"></i>
              {{localize "SEASONS_STARS.dialog.calendar_selection.browse"}}
            </button>
          </div>
          {{/if}}
        </div>
      </div>
      {{else}}
      <div class="detail-placeholder">
        <i class="fas fa-calendar-alt placeholder-icon"></i>
        <p>{{localize "SEASONS_STARS.dialog.calendar_selection.select_to_view"}}</p>
      </div>
      {{/if}}
    </div>
  </div>
</div>